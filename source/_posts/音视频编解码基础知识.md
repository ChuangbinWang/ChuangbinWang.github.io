---
title: 音视频编解码基础知识
date: 2019-09-20 15:37:32
categories: 
    -音视频
tags:
    -编解码
    -基础
---

音视频编解码器有：
OPUS 		最新的协议，支持 口 耳模式 不支持RTMP
AAC			用于直播系统多	支持RTMP 有高保真的效果
Speex		支持回音消除，降噪算法 支持RTMP 
G.711 		常用于固话

音频编解码频带和压缩性能对比图

![pic_1](/images/audio_video/image.png)

AAC诞生的目的是为了取代MP3

mp3的规范是mpeg2  （mpeg2 有损压缩）
mpeg4 规范中，AAC加入了SBR技术和PS技术  相较MPEG2音质更好，压缩比更高

AAC的常见规格 是AAC LC, AAC HE V1, AAC HE V2
![pic_1](/images/audio_video/image1.png)
AAC HE V2 = AAC HE V1 + PS
AAC HE V1 = AAC + SBR

LC = low complexity
he = lc + sbr (spectral band replication 分频复用)

在lc中采样率固定的时候 低频采用的 次数  会很多，而高频采用次数会很少，不协调，he则降低低频采样次数增加高频采样次数

he v2 = aac  lc + sbr +ps (双声道分别保存)  一个声道的数据完整保存，另一个声道只存差异数据

文件格式
adif 格式 这种格式只能从头开始解码，音频各种信息都保存到文件头部 
adts格式 每一帧都有一个同步字，使得在流传输的时候可以从任何位置开始解码

在RTMP和FLV文件格式里都是使用adts


AAC的编解码库 效率对比
libfdk_aac > ffmpeg_aac > libfaac > libvo_aacenc

手机是通过音视频采集模块将数据采集成 PCM/YUV数据，然后通过硬件编码器将它们压缩成 AAC（LC）/H264。


H264编码格式中
B桢是向前向后参考帧，B帧越多，压缩比越高 ，但是在直播系统中，得等到下一帧来了才能解码，所以延迟会高

GOF = group of frame  一组帧 组帧头是SPS, PPS(他们两个被划入I帧)
SPS  序列参数集， 存放帧信息，
PPS 图像参数集

花屏的原因： GOF中的P帧丢失， 避免花屏，但一个GOF钟的P帧丢失就不显示这个GOF,但是会引起卡顿

视频编解码器
x264 市面上用最多
x265 压缩比更高，占用cpu更多
open H264 性能低一些相对于x264支持SVC（视频分层传输，根据网络情况，选择发送层数）技术

SVC在移动端，很多硬件解码不支持，只能使用软编，使用svc可以适用各种带宽情况

H264压缩技术
基础概念
帧内预测压缩，对人眼不敏感的数据进行压缩
帧间预测压缩 压缩帧与帧之间相同数据
DCT 
cbac压缩，无损压缩，类似于哈夫曼编码
将每一帧数据进行宏块划分，宏块内部再进行子块划分，
对相似性高的 帧进行帧规划，形成帧分组

帧间预测压缩  过程
组内宏块查找 -》 运动估算 -》 运动矢量和补偿压缩  -》得到运动矢量数据 + 基础背景数据
![pic_1](/images/audio_video/image2.png)

帧内预测压缩过程
对帧内的所有宏块进行选择，选择一种帧内预测模式（共九种模式）
![pic_1](/images/audio_video/image3.png)
对已经进行预测的图片和原图进行对比 计算出帧内预测残缺值，得到残缺值图，如下右图 黑色部分
![pic_1](/images/audio_video/image4.png)
最后把预测的图片和残缺值进行保存压缩。
解压的时候 把 预测图片和 残缺值进行相加即可得出原图


DCT压缩
把宏块进行量化，然后丢入DCT压缩算法，得到量化结果
![pic_1](/images/audio_video/image5.png)

VLC压缩 是MPEG2 规范中的 （类似哈夫曼编码的） 但是是有损的
H264规范中 使用的是CABAC 压缩，还增加了 上下文适用的压缩规则 无损压缩
![pic_1](/images/audio_video/image6.png)
 

H264的结构图
![pic_1](/images/audio_video/image7.png)
H264编码分层
NAL 层以太网最多1500字节 为传输单元 而H264的帧大于1500字节。所以需要进行拆包，NAL层就进行拆包组包工作
VCL video coding layer 视频数据编码层 就是如上讲是视频压缩算法编码算法等

码流的概念：
SODB string of data bits  原始码流，长度不一定是8的倍速 由VCL产生
RBSP 在SODB 后补位 补足为8的倍速
EBSP 在每个帧的起始位 加入特殊标识

NALU 就是在EBSP上 加一个字节的NAL起始头形成NAL单元
H264中把一个帧分为  n个切片， 一帧至少有一个切片（因为在网络传输的时候，可能会把一帧拆开进行传输，就按照切片分）
nal单元  = nalu 头 + 一个切片 （切片头 + 切片数据）
切片和宏块的关系
![pic_1](/images/audio_video/image8.png)
 起始码是起始标记 0x00 0x01
![pic_1](/images/audio_video/image9.png)

YUV 颜色编码方法 Y 明亮度 UV 表示色度
YUV的组织形式
![pic_1](/images/audio_video/image10.png)
yuv 存储格式
![pic_1](/images/audio_video/image11.png)
![pic_1](/images/audio_video/image12.png)

